abi <abi/3.0>,

include <tunables/global>

# Generated by hand-tuning the result of aa-genprof according to the
# AppArmor documentation and server behavior.
#
# Resources:
# https://wiki.archlinux.org/title/AppArmor
# https://manpages.ubuntu.com/manpages/jammy/en/man5/apparmor.d.5.html
# https://opensuse-security.opensuse.narkive.com/larQcj8k/confining-java-applications
profile "{{ user }}-purpur-mc-server" {
  include <abstractions/base>
  include <abstractions/nameservice>
  include <abstractions/ssl_certs>
  include <abstractions/user-tmp>

  # Allow the JVM to run
  /home/{{ java_sdkman_user }}/.sdkman/candidates/java/{{ java_version }}/bin/java mr,
  /home/{{ java_sdkman_user }}/.sdkman/candidates/java/{{ java_version }}/lib/**.so* mr,
  /home/{{ java_sdkman_user }}/.sdkman/candidates/java/{{ java_version }}/** r,

  # Allow the JVM to spawn processes that comply with our AppArmor profile
  /home/{{ java_sdkman_user }}/.sdkman/candidates/java/{{ java_version }}/lib/jspawnhelper mrix,

  # Misc files opened by the Minecraft server
  /usr/lib{,32,64}/ r,
  /etc/timezone r,
  /usr/bin/stty Ux,
  /usr/bin/tty Ux,

  owner /proc/*/coredump_filter rw,
  owner /proc/** r,
  owner /proc/*/stat r,
  /proc/*/net/** r,
  /proc/cgroups r,
  /proc/kallsyms r,
  /sys/fs/cgroup/** r,
  /sys/devices/system/cpu/** r,

  # Silence audit logs from commands the Minecraft server wants to run
  # but doesn't really need
  deny /usr/bin/lshw x,
  deny /usr/bin/lspci x,
  deny /usr/bin/uname x,
  deny /usr/sbin/ldconfig x,
  deny /usr/bin/ldd x,
  deny /usr/bin/which* x,

  # Native libraries extracted and loaded by some Java libraries
  @{HOME}/.cache/** mrw,
  owner /tmp/** m,

  # Grant access to server data
  {{ directory }}{,/**} mrwk,

  # Restart script
  {{ directory }}/restart.sh ix,
  /usr/bin/dash ix,

  @{HOME}/.local/bin/* r,
  /usr/bin/cat ix,
  owner /run/user/** r,
  signal (send) set=(pwr),
}
